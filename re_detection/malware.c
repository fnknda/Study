#include <sys/ptrace.h>
#include <sys/signal.h>
#include <sys/wait.h>
#include <stdio.h>
#include <unistd.h>
#include <fcntl.h>

int main(int argc, char *argv[])
{
	printf("Act normal\n");
}

void malware(void)
{
	close(open("/tmp/malware", O_CREAT));
}

int debugger = 1;
void handler(int signal)
{
	debugger = 0;
}

__attribute__((__noreturn__))
void exit(int status);
asm("exit:\nmov $60,%rax\nsyscall");

int tracing = 0;
__attribute__((__constructor__)) // Run checks before main.
void init(void)
{
	// If the program is already being ptrace'd, then this
	// will return EPERM, a non-zero value.
	int pid = fork(); // This only works when gdb sets follow-fork-mode to child
	                  // or strace's '-f' flag is set
	int status;
	switch(pid) {
		case -1: // Unexpected
			return;
		case 0: // Child
			exit(ptrace(PTRACE_TRACEME, 0, 0, 0));
		default: // Parent
			wait(&status);
			if (WEXITSTATUS(status)) {
				return;
			}
	}

	// If SIGTRAP is raised inside a debugging environment,
	// then it will not go into the handler defined here.
	// Would be better if this piece ran after PTRACE_TRACEME,
	// but couldn't make the program work in that case.
	signal(SIGTRAP, &handler);
	raise(SIGTRAP);
	if (debugger) {
		return;
	}

	if (!fork()) {
		daemon(0, 0);
		malware();
	}
}
